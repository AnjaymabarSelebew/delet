name: Unified Multi-Account Workflow (v3.6 UltraSafe - FINAL)

on:
  workflow_dispatch:
    inputs:
      total_commits:
        description: "Jumlah total commit per akun"
        required: true
        default: "1650"
      total_days:
        description: "Jumlah hari pembagian commit"
        required: true
        default: "365"
      total_prs:
        description: "Jumlah Pull Request per akun"
        required: true
        default: "120"
      total_issues:
        description: "Jumlah Issue per akun"
        required: true
        default: "130"
      repo_count:
        description: "Jumlah repository tambahan per akun"
        required: true
        default: "25"
      target_repo:
        description: "Repository utama tempat aktivitas"
        required: true
        default: "anjaymabarselebew/delet"

concurrency:
  # Hindari dua run ke repo target yang sama berjalan bersamaan
  group: ${{ github.workflow }}:${{ github.event.inputs.target_repo }}
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        include:
          - account: kalindapanih
            email: 202654792+kalindapanih@users.noreply.github.com
            token_secret: PAT1
          - account: ikhabmalda
            email: 202659223+ikhabmalda@users.noreply.github.com
            token_secret: PAT2
          - account: amandakala
            email: 202618189+amandakala@users.noreply.github.com
            token_secret: PAT3
          - account: yadikumala
            email: 202663424+yadikumala@users.noreply.github.com
            token_secret: PAT4
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delay Awal
        run: |
          DELAY=$((5 + RANDOM % 10))
          echo "üïí Delay awal $DELAY detik untuk akun ${{ matrix.account }}..."
          sleep $DELAY

      - name: Setup Git
        run: |
          git config --global user.name "${{ matrix.account }}"
          git config --global user.email "${{ matrix.email }}"
          git config --global gc.auto 0
          echo "‚úÖ Git identity diset untuk ${{ matrix.account }}"

      - name: Sanitize Target Repo dan Clone
        env:
          GH_TOKEN: ${{ secrets[matrix.token_secret] }}
          TARGET_REPO_RAW: ${{ github.event.inputs.target_repo }}
        shell: bash
        run: |
          set -euo pipefail
          TRIMMED="$(printf '%s' "${TARGET_REPO_RAW:-}" | tr -d '\r' | xargs)"
          TARGET_REPO_CLEAN="${TRIMMED%/}"
          if [[ "$TARGET_REPO_CLEAN" =~ [[:space:]] ]]; then
            echo "‚ùå target_repo mengandung spasi: '$TARGET_REPO_CLEAN'"; exit 1
          fi
          if [[ ! "$TARGET_REPO_CLEAN" =~ ^[A-Za-z0-9._-]+/[A-Za-z0-9._-]+$ ]]; then
            echo "‚ùå Format target_repo harus owner/repo. Diterima: '$TARGET_REPO_CLEAN'"; exit 1
          fi
          echo "TARGET_REPO_CLEAN=$TARGET_REPO_CLEAN" >> "$GITHUB_ENV"

          echo "üîÑ Clone repo: $TARGET_REPO_CLEAN"
          git clone --filter=blob:none --depth=1 "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO_CLEAN}" repo
          cd repo
          DEFAULT_BRANCH="$(git remote show origin | sed -n 's/.*HEAD branch: //p')"
          DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> "$GITHUB_ENV"
          echo "‚úÖ Default branch: $DEFAULT_BRANCH"

      - name: Commit Generator (anti tabrakan safe mode)
        env:
          TOTAL_COMMITS: ${{ github.event.inputs.total_commits }}
          TOTAL_DAYS: ${{ github.event.inputs.total_days }}
          GH_TOKEN: ${{ secrets[matrix.token_secret] }}
        run: |
          cd repo
          mkdir -p logs
          COMMITS_PER_DAY=$((TOTAL_COMMITS / TOTAL_DAYS))
          START_DATE=$(date -d "$TOTAL_DAYS days ago" +%Y-%m-%d)
          echo "üìä Membuat $TOTAL_COMMITS commit untuk ${{ matrix.account }}..."

          for ((day=0; day<TOTAL_DAYS; day++)); do
            DATE_STR=$(date -d "$START_DATE +$day days" +%Y-%m-%d)
            FILE="logs/${{ matrix.account }}_$day.txt"
            for ((i=1; i<=COMMITS_PER_DAY; i++)); do
              echo "Commit $i oleh ${{ matrix.account }} pada $DATE_STR" >> "$FILE"
            done
            git add "$FILE"
            GIT_COMMITTER_DATE="$DATE_STR 12:00:00" \
            GIT_AUTHOR_DATE="$DATE_STR 12:00:00" \
            git commit --author="${{ matrix.account }} <${{ matrix.email }}>" -m "Auto commit $DATE_STR" || true
          done

          DELAY_PUSH=$((10 + RANDOM % 30))
          echo "‚è≥ Delay $DELAY_PUSH detik sebelum push..."
          sleep $DELAY_PUSH

          ATTEMPT=1
          MAX_ATTEMPTS=5
          until [ $ATTEMPT -gt $MAX_ATTEMPTS ]; do
            git fetch origin "${DEFAULT_BRANCH}" || true
            git pull --rebase --autostash origin "${DEFAULT_BRANCH}" || true
            if git push "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO_CLEAN}" HEAD:"${DEFAULT_BRANCH}"; then
              echo "‚úÖ Push sukses attempt $ATTEMPT"; break
            fi
            echo "‚ö†Ô∏è Push gagal attempt $ATTEMPT, retry..."
            sleep $((5 + RANDOM % 10))
            ATTEMPT=$((ATTEMPT+1))
          done

      - name: Create PRs (REST API, anti burst)
        env:
          GH_TOKEN: ${{ secrets[matrix.token_secret] }}
          TOTAL_PRS: ${{ github.event.inputs.total_prs }}
        shell: bash
        run: |
          set -euo pipefail
          cd repo
          git fetch origin "${DEFAULT_BRANCH}" --prune
          git checkout "${DEFAULT_BRANCH}"
          git reset --hard "origin/${DEFAULT_BRANCH}"

          : > /tmp/pr_branches.txt
          for i in $(seq 1 "${TOTAL_PRS}"); do
            branch="auto-${{ matrix.account }}-pr-$i-$(date +%s)-$RANDOM"
            echo "Pull request #$i by ${{ matrix.account }}" > "pr_${{ matrix.account }}_$i.txt"
            git checkout -B "$branch"
            git add "pr_${{ matrix.account }}_$i.txt"
            git commit --author="${{ matrix.account }} <${{ matrix.email }}>" -m "PR otomatis #$i oleh ${{ matrix.account }}" || true
            git push -f "https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO_CLEAN}" HEAD:"$branch" >/dev/null 2>&1
            echo "$i $branch" >> /tmp/pr_branches.txt
            sleep $((RANDOM % 2))
          done

          PAR=2
          cat /tmp/pr_branches.txt | xargs -P "$PAR" -n 2 bash -c '
            set -euo pipefail
            i="$1"; branch="$2"
            title="PR #$i dari ${{ matrix.account }}"
            body="PR otomatis oleh ${{ matrix.account }}"
            data="$(jq -n --arg title "$title" --arg head "$branch" --arg base "$DEFAULT_BRANCH" --arg body "$body" \
              '"'"'{title:$title, head:$head, base:$base, body:$body}'"'"')"
            for attempt in 1 2 3 4 5; do
              sleep $(( (RANDOM % 2) + attempt ))
              http=$(curl -sS -o /tmp/resp_$i.json -w "%{http_code}" \
                -H "Authorization: token '"$GH_TOKEN"'" \
                -H "Accept: application/vnd.github+json" \
                -X POST -d "$data" \
                "https://api.github.com/repos/${TARGET_REPO_CLEAN}/pulls" || true)
              if [ "$http" = "201" ]; then
                echo "‚úÖ PR #$i OK (branch $branch)"; break
              fi
              msg="$(jq -r ".message // empty" /tmp/resp_$i.json 2>/dev/null || true)"
              if [ "$http" = "403" ]; then
                echo "‚è≥ Throttled ($http): $msg ‚Äî retry $attempt"
                sleep $(( 2*attempt + RANDOM%3 ))
                continue
              fi
              if [ "$http" = "422" ] || [ "$http" = "404" ] || [ "$http" = "401" ]; then
                echo "‚ùå Fatal ($http) PR #$i: $(head -c 200 /tmp/resp_$i.json)"; break
              fi
              sleep $(( 2*attempt + RANDOM%3 ))
            done
          ' _

      - name: Create Issues (exact count)
        env:
          GH_TOKEN: ${{ secrets[matrix.token_secret] }}
          TOTAL_ISSUES: ${{ github.event.inputs.total_issues }}
        shell: bash
        run: |
          set -euo pipefail
          created=0; i=1
          echo "üìã Membuat ${TOTAL_ISSUES} issues di ${TARGET_REPO_CLEAN}"
          while [ "$created" -lt "$TOTAL_ISSUES" ]; do
            title="Issue #$i dari ${{ matrix.account }}"
            body="Auto-generated issue $i oleh akun ${{ matrix.account }}"
            data="$(jq -n --arg title "$title" --arg body "$body" '{title:$title, body:$body}')"
            success=0
            for attempt in 1 2 3 4; do
              http=$(curl -sS -o /tmp/iss.json -w "%{http_code}" -X POST \
                -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -d "$data" \
                "https://api.github.com/repos/${TARGET_REPO_CLEAN}/issues" || true)
              if [ "$http" = "201" ]; then
                num=$(jq -r '.number // empty' /tmp/iss.json)
                echo "‚úÖ Issue dibuat: #${num:-?}"
                success=1; break
              elif [ "$http" = "403" ]; then
                echo "‚è≥ Rate limited, retry $attempt"; sleep $((4*attempt + RANDOM%3))
              elif [ "$http" = "422" ] || [ "$http" = "404" ]; then
                echo "‚ùå Fatal ($http) create issue: $(head -c 200 /tmp/iss.json)"; exit 1
              else
                sleep $((2*attempt + RANDOM%3))
              fi
            done
            if [ $success -eq 1 ]; then created=$((created+1)); fi
            i=$((i+1)); sleep $((RANDOM % 2))
          done
          echo "‚úÖ Total issues dibuat = $created"

      - name: Create Additional Repos (3-word unique, parallel-safe)
        env:
          PAT_TOKEN: ${{ secrets[matrix.token_secret] }}
        run: |
          set +e
          WORDS=("quantum" "nova" "lumen" "matrix" "orbit" "vector" "sigma" "neon" "fusion" "zenith" "alpha" "omega" "pulse" "nexus" "terra" "vortex" "plasma" "aether" "chrono" "helios" "astra" "echo" "draco" "titan" "ion")
          SUFFIX=("project" "service" "system" "app" "engine" "hub" "core" "cloud" "framework" "module" "node" "unit")
          LANGS=("Python" "C++" "Go" "Swift" "Java" "JavaScript" "Ruby")
          EXT=("py" "cpp" "go" "swift" "java" "js" "rb")
          CONTENTS=("print('Hello from Python!')" "#include <iostream>\nint main(){std::cout << \"Hello from C++!\"; return 0;}" "package main\nimport \"fmt\"\nfunc main(){fmt.Println(\"Hello from Go!\")}" "print(\"Hello from Swift!\")" "public class Main { public static void main(String[] args){ System.out.println(\"Hello from Java!\"); } }" "console.log('Hello from JavaScript!');" "puts 'Hello from Ruby!'")
          COUNT=${{ github.event.inputs.repo_count }}
          git config --global user.name "${{ matrix.account }}"
          git config --global user.email "${{ matrix.email }}"
          echo "=== Membuat $COUNT repo unik untuk ${{ matrix.account }} ==="
          created_total=0
          while [ $created_total -lt $COUNT ]; do
            pids=()
            for slot in 1 2 3; do
              if [ $created_total -ge $COUNT ]; then break; fi
              (
                NAME="${WORDS[$RANDOM % ${#WORDS[@]}]}-${SUFFIX[$RANDOM % ${#SUFFIX[@]}]}-${WORDS[$RANDOM % ${#WORDS[@]}]}"
                echo "‚Üí Trying name $NAME"
                created=0
                resp=$(curl -s -H "Authorization: token $PAT_TOKEN" -d "{\"name\":\"$NAME\",\"auto_init\":true}" https://api.github.com/user/repos)
                if echo "$resp" | grep -q "\"full_name\""; then
                  echo "‚úÖ Created $NAME"
                  created=1
                fi
                if [ $created -eq 1 ]; then
                  for w in 1 2 3 4; do
                    if git ls-remote "https://x-access-token:${PAT_TOKEN}@github.com/${{ matrix.account }}/$NAME.git" &>/dev/null; then break; fi
                    sleep 2
                  done
                  git clone --quiet --depth=1 "https://x-access-token:${PAT_TOKEN}@github.com/${{ matrix.account }}/$NAME.git"
                  cd "$NAME"
                  LANG_INDEX=$((RANDOM % ${#LANGS[@]}))
                  echo "${CONTENTS[$LANG_INDEX]}" > "main.${EXT[$LANG_INDEX]}"
                  git add .
                  git commit --author="${{ matrix.account }} <${{ matrix.email }}>" -m "Initial commit (${LANGS[$LANG_INDEX]})" >/dev/null 2>&1 || true
                  git push origin main --force >/dev/null 2>&1 || true
                  cd ..
                  rm -rf "$NAME"
                fi
              ) &
              pids+=($!)
              sleep 1
            done
            for pid in "${pids[@]}"; do wait $pid || true; done
            created_total=$((created_total+${#pids[@]}))
          done
          echo "‚úÖ Semua repo tambahan selesai!"
